############################################################################
#
# Copyright (c) 2018-2019 Charles Anthony <charles.unix.pro@gmail.com>
# Copyright (c) 2019-2020 Eric Swenson <eric@swenson.org>
# Copyright (c) 2021 Jeffrey H. Johnson <trnsz@pobox.com>
# Copyright (c) 2021 The DPS8M Development Team
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.  This file is offered "AS-IS",
# without any warranty.
#
############################################################################
# GitLab CI/CD Configuraton
############################################################################

.scriptCommon: &scriptCommon |
    # scriptCommon
    echo "Project Name              : $CI_PROJECT_TITLE"
    echo "Project Git Commit        : $CI_COMMIT_SHA"
    echo "Project Git Branch        : $CI_COMMIT_BRANCH"
    echo "GitLab CI User Details    : $GITLAB_USER_LOGIN - $GITLAB_USER_NAME ($GITLAB_USER_ID) $GITLAB_USER_EMAIL"
    echo "GitLab CI Job Name        : $CI_JOB_NAME"
    echo "GitLab CI Job ID          : $CI_JOB_ID"
    echo "GitLab CI Job Stage       : $CI_JOB_STAGE"
    echo "GitLab CI Runner Details  : $CI_RUNNER_VERSION ($CI_RUNNER_REVISION)"

############################################################################

.scriptBuildlibuvCLANGlatest: &scriptBuildlibuvCLANGlatest |
    # scriptBuildlibuvCLANGlatest
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=clang-latest ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvGCClatest: &scriptBuildlibuvGCClatest |
    # scriptBuildlibuvGCClatest
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=gcc-latest ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvCLANG: &scriptBuildlibuvCLANG |
    # scriptBuildlibuvCLANG
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=clang ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvGCC: &scriptBuildlibuvGCC |
    # scriptBuildlibuvGCC
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=gcc ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvMGW64: &scriptBuildlibuvMGW64 |
    # scriptBuildlibuvMGW64
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    ./configure --disable-shared --enable-static --host=x86_64-w64-mingw32
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptAptSetupLLVM: &scriptAptSetupLLVM |
    # scriptAptSetupLLVM
    uname -a 2> /dev/null || true > /dev/null 2>&1
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" update -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" update -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash gnupg2 bash curl wget git lsb-release software-properties-common time || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash gnupg2 bash curl wget git lsb-release software-properties-common time
    wget -nv https://apt.llvm.org/llvm.sh || wget -nv https://apt.llvm.org/llvm.sh
    chmod a+x ./llvm.sh || true > /dev/null 2>&1
    bash ./llvm.sh
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash bash wget mingw-w64 gcc libtool unzip autoconf-archive timelimit util-linux psmisc clang zip pigz make ccache || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash bash wget mingw-w64 gcc libtool unzip autoconf-archive timelimit util-linux psmisc clang zip pigz make ccache
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq cpuid global cscope virt-what || true > /dev/null 2>&1
    clang --version 2> /dev/null || true > /dev/null 2>&1
    gcc --version 2> /dev/null ||  true > /dev/null 2>&1
    cc --version 2> /dev/null || true > /dev/null 2>&1
    ld --version 2> /dev/null || true > /dev/null 2>&1
    lld --version 2> /dev/null || true > /dev/null 2>&1
    lsb_release -d 2> /dev/null || true > /dev/null 2>&1
    cat /etc/*elease 2> /dev/null || true > /dev/null 2>&1
    whoami 2> /dev/null || true > /dev/null 2>&1
    w 2> /dev/null || true > /dev/null 2>&1
    pstree 2> /dev/null || true > /dev/null 2>&1
    uptime 2> /dev/null || true > /dev/null 2>&1
    lscpu 2> /dev/null | grep -v Vulnerability 2> /dev/null || true > /dev/null 2>&1
    cpuid -1 2> /dev/null || true > /dev/null 2>&1
    virt-what 2> /dev/null || true > /dev/null 2>&1
    df 2> /dev/null || true > /dev/null 2>&1
    free 2> /dev/null || true > /dev/null 2>&1
    echo "The DPS8M Development Team - CI/CD Test Build ${CI_JOB_ID:-}" 2> /dev/null | tee .builder.txt 2> /dev/null || true > /dev/null 2>&1
    sed -i -s 's/\.NOTPARALLEL.*$//g' $(find . -name '*akefile*' 2> /dev/null) 2> /dev/null || true > /dev/null 2>&1
    ln -fs "$( ( ls -1 /usr/bin/clang-* 2> /dev/null | grep 'clang-[0-9]' 2> /dev/null | sort -r 2> /dev/null | head -n 1 2> /dev/null ) || echo /usr/bin/clang)" /usr/bin/clang-latest
    ln -fs "$( ( ls -1 /usr/bin/gcc-* 2> /dev/null | grep 'gcc-[0-9]' 2> /dev/null | sort -r 2> /dev/null | head -n 1 2> /dev/null ) || echo /usr/bin/gcc)" /usr/bin/gcc-latest
    /usr/bin/clang-latest --version
    /usr/bin/gcc-latest --version

############################################################################

.scriptAptSetup: &scriptAptSetup |
    # scriptAptSetup
    uname -a 2> /dev/null || true > /dev/null 2>&1
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" update -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" update -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash gnupg2 bash curl wget git lsb-release software-properties-common time || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash gnupg2 bash curl wget git lsb-release software-properties-common time
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash bash wget mingw-w64 gcc libtool unzip autoconf-archive timelimit util-linux psmisc clang zip pigz make ccache || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq dash bash wget mingw-w64 gcc libtool unzip autoconf-archive timelimit util-linux psmisc clang zip pigz make ccache
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq cpuid global cscope virt-what || true > /dev/null 2>&1
    clang --version 2> /dev/null || true > /dev/null 2>&1
    gcc --version 2> /dev/null ||  true > /dev/null 2>&1
    cc --version 2> /dev/null || true > /dev/null 2>&1
    ld --version 2> /dev/null || true > /dev/null 2>&1
    lld --version 2> /dev/null || true > /dev/null 2>&1
    lsb_release -d 2> /dev/null || true > /dev/null 2>&1
    cat /etc/*elease 2> /dev/null || true > /dev/null 2>&1
    whoami 2> /dev/null || true > /dev/null 2>&1
    w 2> /dev/null || true > /dev/null 2>&1
    pstree 2> /dev/null || true > /dev/null 2>&1
    uptime 2> /dev/null || true > /dev/null 2>&1
    lscpu 2> /dev/null | grep -v Vulnerability 2> /dev/null || true > /dev/null 2>&1
    cpuid -1 2> /dev/null || true > /dev/null 2>&1
    virt-what 2> /dev/null || true > /dev/null 2>&1
    df 2> /dev/null || true > /dev/null 2>&1
    free 2> /dev/null || true > /dev/null 2>&1
    echo "The DPS8M Development Team - CI/CD Test Build ${CI_JOB_ID:-}" 2> /dev/null | tee .builder.txt 2> /dev/null || true > /dev/null 2>&1
    sed -i -s 's/\.NOTPARALLEL.*$//g' $(find . -name '*akefile*' 2> /dev/null) 2> /dev/null || true > /dev/null 2>&1
    ln -fs "$( ( ls -1 /usr/bin/clang-* 2> /dev/null | grep 'clang-[0-9]' 2> /dev/null | sort -r 2> /dev/null | head -n 1 2> /dev/null ) || echo /usr/bin/clang)" /usr/bin/clang-latest
    ln -fs "$( ( ls -1 /usr/bin/gcc-* 2> /dev/null | grep 'gcc-[0-9]' 2> /dev/null | sort -r 2> /dev/null | head -n 1 2> /dev/null ) || echo /usr/bin/gcc)" /usr/bin/gcc-latest
    /usr/bin/clang-latest --version
    /usr/bin/gcc-latest --version

############################################################################

.scriptDnfSetup: &scriptDnfSetup |
    # scriptDnfSetup
    uname -a 2> /dev/null || true > /dev/null 2>&1
    dnf -y --refresh --allowerasing --nobest update || dnf -y --refresh --allowerasing --nobest update
    dnf -y --allowerasing --nobest install libuv-devel libtool unzip autoconf autoconf-archive timelimit util-linux psmisc zip pigz make ccache cpuid global cscope virt-what dash gnupg2 bash curl wget git redhat-lsb time gcc clang \@"base" \@"Minimal Install" \@"RPM Development Tools" \@"Development Tools" \@"C Development Tools and Libraries" || dnf -y --allowerasing --nobest install libuv-devel libtool unzip autoconf autoconf-archive timelimit util-linux psmisc zip pigz make ccache cpuid global cscope virt-what dash gnupg2 bash curl wget git redhat-lsb time gcc clang \@"base" \@"Minimal Install" \@"RPM Development Tools" \@"Development Tools" \@"C Development Tools and Libraries"
    clang --version 2> /dev/null || true > /dev/null 2>&1
    gcc --version 2> /dev/null ||  true > /dev/null 2>&1
    cc --version 2> /dev/null || true > /dev/null 2>&1
    ld --version 2> /dev/null || true > /dev/null 2>&1
    lld --version 2> /dev/null || true > /dev/null 2>&1
    lsb_release -d 2> /dev/null || true > /dev/null 2>&1
    cat /etc/*elease 2> /dev/null || true > /dev/null 2>&1
    whoami 2> /dev/null || true > /dev/null 2>&1
    w 2> /dev/null || true > /dev/null 2>&1
    pstree 2> /dev/null || true > /dev/null 2>&1
    uptime 2> /dev/null || true > /dev/null 2>&1
    lscpu 2> /dev/null | grep -v Vulnerability 2> /dev/null || true > /dev/null 2>&1
    cpuid -1 2> /dev/null || true > /dev/null 2>&1
    virt-what 2> /dev/null || true > /dev/null 2>&1
    df 2> /dev/null || true > /dev/null 2>&1
    free 2> /dev/null || true > /dev/null 2>&1
    echo "The DPS8M Development Team - CI/CD Test Build ${CI_JOB_ID:-}" 2> /dev/null | tee .builder.txt 2> /dev/null || true > /dev/null 2>&1
    sed -i -s 's/\.NOTPARALLEL.*$//g' $(find . -name '*akefile*' 2> /dev/null) 2> /dev/null || true > /dev/null 2>&1

############################################################################

stages:
  - build

############################################################################

Linux/x86_64, Debian sid, clang/upstream, libuv/upstream:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetupLLVM
    - *scriptCommon
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/upstream, libuv/upstream, TESTING:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetupLLVM
    - *scriptCommon
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" TESTING=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/upstream, libuv/upstream, TESTING TRACKER HDBG WAM ISOLTS:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetupLLVM
    - *scriptCommon
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" TESTING=1 TRACKER=1 HDBG=1 WAM=1 W=1 V=1 ISOLTS=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/upstream, libuv/upstream, L68:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetupLLVM
    - *scriptCommon
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" L68=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, gcc, libuv/upstream:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptBuildlibuvGCClatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/upstream, libuv/upstream, NO_LOCKLESS:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetupLLVM
    - *scriptCommon
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" NO_LOCKLESS=1 LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/upstream, libuv/upstream, NO_LOCKLESS ROUND_ROBIN:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetupLLVM
    - *scriptCommon
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" NO_LOCKLESS=1 LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" ROUND_ROBIN=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/upstream, libuv/upstream, L68 NO_LOCKLESS:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetupLLVM
    - *scriptCommon
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" NO_LOCKLESS=1 LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" L68=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Windows/MinGW64, Debian sid, MinGW64-gcc, libuv/upstream:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptBuildlibuvMGW64
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC="x86_64-w64-mingw32-gcc -I/usr/local/include -L/usr/local/lib -pthread" CROSS="MINGW64" LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8.exe
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf.exe
      - /builds/dps8m/dps8m/src/punutil/punutil.exe
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Source Kit:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - sh -x -c 'make dist V=1 COMPRESS="pigz -f" COMPRESSXT="gz" -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/sources.tar.gz
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu LTS, clang:
  image: ubuntu:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu LTS, gcc:
  image: ubuntu:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora Rawhide, clang:
  image: fedora:rawhide
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora Rawhide, gcc:
  image: fedora:rawhide
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora, clang:
  image: fedora:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora, gcc:
  image: fedora:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Oracle Linux 8, clang:
  image: oraclelinux:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Oracle Linux 8, gcc:
  image: oraclelinux:8
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu, clang:
  image: ubuntu:rolling
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu, gcc:
  image: ubuntu:rolling
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | timelimit -T 10 "./src/dps8/dps8" ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################
