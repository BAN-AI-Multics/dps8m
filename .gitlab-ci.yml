############################################################################
#
# Copyright (c) 2018-2019 Charles Anthony <charles.unix.pro@gmail.com>
# Copyright (c) 2019-2020 Eric Swenson <eric@swenson.org>
# Copyright (c) 2021 Jeffrey H. Johnson <trnsz@pobox.com>
# Copyright (c) 2021 The DPS8M Development Team
#
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.  This file is offered "AS-IS",
# without any warranty.
#
############################################################################
# GitLab CI/CD Configuraton
############################################################################

.scriptCommon: &scriptCommon |
    # scriptCommon
    echo "Project Name              : $CI_PROJECT_TITLE"
    echo "Project Git Commit        : $CI_COMMIT_SHA"
    echo "Project Git Branch        : $CI_COMMIT_BRANCH"
    echo "GitLab CI User Details    : $GITLAB_USER_LOGIN - $GITLAB_USER_NAME ($GITLAB_USER_ID) $GITLAB_USER_EMAIL"
    echo "GitLab CI Job Name        : $CI_JOB_NAME"
    echo "GitLab CI Job ID          : $CI_JOB_ID"
    echo "GitLab CI Job Stage       : $CI_JOB_STAGE"
    echo "GitLab CI Runner Details  : $CI_RUNNER_VERSION ($CI_RUNNER_REVISION)"

############################################################################

.scriptAptInstallLibuv1: &scriptAptInstallLibuv1 |
    # scriptAptInstallLibuv1
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq libuv1-dev

############################################################################

.scriptAptInstallMinGW64: &scriptAptInstallMinGW64 |
    # scriptAptInstallMinGW64
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq mingw-w64 || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq mingw-w64

############################################################################

.scriptBuildlibuvCLANGlatest: &scriptBuildlibuvCLANGlatest |
    # scriptBuildlibuvCLANGlatest
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=clang-latest ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvGCClatest: &scriptBuildlibuvGCClatest |
    # scriptBuildlibuvGCClatest
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=gcc-latest ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvCLANG: &scriptBuildlibuvCLANG |
    # scriptBuildlibuvCLANG
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=clang ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvGCC: &scriptBuildlibuvGCC |
    # scriptBuildlibuvGCC
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    CC=gcc ./configure --disable-shared --enable-static
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvMGW64: &scriptBuildlibuvMGW64 |
    # scriptBuildlibuvMGW64
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    ./configure --disable-shared --enable-static --host=x86_64-w64-mingw32
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvLLVMMGW64-x86_64: &scriptBuildlibuvLLVMMGW64-x86_64 |
    # scriptBuildlibuvLLVMMGW64-x86_64
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    ./configure --disable-shared --enable-static --host=x86_64-w64-mingw32-clang
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptBuildlibuvLLVMMGW64-aarch64: &scriptBuildlibuvLLVMMGW64-aarch64 |
    # scriptBuildlibuvLLVMMGW64-aarch64
    wget -nv https://github.com/libuv/libuv/archive/v1.x.zip
    unzip -xa v1.x.zip && cd libuv-1.x && sh ./autogen.sh
    ./configure --disable-shared --enable-static --host=aarch64-w64-mingw32-clang
    make -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") && make install && cd ..

############################################################################

.scriptAptSetupLatestClang: &scriptAptSetupLatestClang |
    # scriptAptSetupLatestClang
    wget -nv https://apt.llvm.org/llvm.sh || wget -nv https://apt.llvm.org/llvm.sh
    chmod a+x ./llvm.sh
    grep -v '^set -eux' ./llvm.sh | sponge ./llvm.sh
    bash ./llvm.sh $(grep '^LLVM_VERSION_PATTERNS' ./llvm.sh | cut -d '[' -f 2 | cut -d ']' -f 1 | sort -rn | head -n 1)
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq $( apt-cache search clang 2> /dev/null | grep "^clang-[1-9]\+ " 2> /dev/null | sort 2> /dev/null | head -n 1 2> /dev/null | awk '{ print $1 }' 2>/dev/null || echo clang)
    ln -fs "$( ( ls -1 /usr/bin/clang-* 2> /dev/null | grep 'clang-[0-9]' 2> /dev/null | sort -r 2> /dev/null | head -n 1 2> /dev/null ) || echo /usr/bin/clang)" /usr/bin/clang-latest

############################################################################

.scriptAptSetupLatestGCC: &scriptAptSetupLatestGCC |
    # scriptAptSetupLatestGCC
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq $( apt-cache search gcc 2> /dev/null | grep "^gcc-[1-9]\+ " 2> /dev/null | sort 2> /dev/null | head -n 1 2> /dev/null | awk '{ print $1 }' 2>/dev/null || echo gcc)
    ln -fs "$( ( ls -1 /usr/bin/gcc-* 2> /dev/null | grep 'gcc-[0-9]' 2> /dev/null | sort -r 2> /dev/null | head -n 1 2> /dev/null ) || echo /usr/bin/gcc)" /usr/bin/gcc-latest

############################################################################

.scriptExtraInfo: &scriptExtraInfo |
    # scriptExtraInfo
    uname -a 2> /dev/null || true > /dev/null 2>&1
    lsb_release -d 2> /dev/null || true > /dev/null 2>&1
    cat /etc/*elease 2> /dev/null || true > /dev/null 2>&1
    uptime 2> /dev/null || true > /dev/null 2>&1
    lscpu 2> /dev/null | grep -v Vulnerability 2> /dev/null || true > /dev/null 2>&1
    df 2> /dev/null || true > /dev/null 2>&1
    free 2> /dev/null || true > /dev/null 2>&1

############################################################################

.scriptDPS8Mods: &scriptDPS8Mods |
    # scriptDPS8Mods
    sed -i -s 's/\.NOTPARALLEL.*$//g' $(find . -name '*akefile*' 2> /dev/null) 2> /dev/null || true > /dev/null 2>&1
    echo "The DPS8M Development Team - CI/CD Test Build ${CI_JOB_ID:-}" 2> /dev/null | tee .builder.txt 2> /dev/null || true > /dev/null 2>&1

############################################################################

.scriptAptSetup: &scriptAptSetup |
    # scriptAptSetup
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" update -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" update -y -qq
    ARGS="gawk moreutils apt-utils dash gnupg2 bash curl wget git lsb-release software-properties-common time"; env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq ${ARGS:?} || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq ${ARGS:?}
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade -y -qq
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" dist-upgrade -y -qq
    ARGS="dash bash wget gcc libtool unzip autoconf-archive util-linux psmisc clang zip pigz make ccache"; env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq ${ARGS:?} || env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq ${ARGS:?}
    env DEBIAN_FRONTEND=noninteractive apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install -y -qq global cscope || true > /dev/null 2>&1

############################################################################

.scriptOUL8Setup: &scriptOUL8Setup |
    # scriptOUL8Setup
    dnf -y --refresh --allowerasing --nobest install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm       
    echo '[OL8_codeready_builder]' > /etc/yum.repos.d/codeready_builder.repo
    echo 'name=OL8_codeready_builder' >> /etc/yum.repos.d/codeready_builder.repo
    echo 'baseurl=https://yum.oracle.com/repo/OracleLinux/OL8/codeready/builder/x86_64/' >> /etc/yum.repos.d/codeready_builder.repo
    echo 'enabled=1' >> /etc/yum.repos.d/codeready_builder.repo
    echo 'gpgcheck=0' >> /etc/yum.repos.d/codeready_builder.repo
    dnf -y module disable virt-devel 2> /dev/null || true > /dev/null 2>&1

############################################################################

.scriptDnfSetup: &scriptDnfSetup |
    # scriptDnfSetup
    dnf -y --refresh --allowerasing --best update || dnf -y --refresh --allowerasing --nobest update
    ARGS="libuv-devel libtool unzip autoconf autoconf-archive util-linux psmisc zip pigz make ccache global cscope dash gnupg2 bash curl wget git redhat-lsb time gcc clang"; dnf -y --allowerasing --best install ${ARGS:?} || dnf -y --allowerasing --nobest install ${ARGS:?}

############################################################################

stages:
  - build

############################################################################

Linux/x86_64, Debian sid, clang/git, libuv/git:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestClang
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/git, libuv/git, TESTING:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestClang
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" TESTING=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/git, libuv/git, TESTING TRACKER HDBG WAM ISOLTS:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestClang
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" TESTING=1 TRACKER=1 HDBG=1 WAM=1 W=1 V=1 ISOLTS=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/git, libuv/git, L68:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestClang
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" L68=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, gcc, libuv/git:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestGCC
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvGCClatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc-latest LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/git, libuv/git, NO_LOCKLESS:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestClang
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" NO_LOCKLESS=1 LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/git, libuv/git, NO_LOCKLESS ROUND_ROBIN:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestClang
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" NO_LOCKLESS=1 LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" ROUND_ROBIN=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Debian sid, clang/git, libuv/git, L68 NO_LOCKLESS:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptSetupLatestClang
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvCLANGlatest
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang-latest LIBUV="/usr/local/lib/libuv.a -lpthread" NO_LOCKLESS=1 LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" L68=1 W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Windows/x86_64, Debian, MinGW64-gcc, libuv/git:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptAptInstallMinGW64
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvMGW64
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC="x86_64-w64-mingw32-gcc -I/usr/local/include -L/usr/local/lib -pthread" CROSS="MINGW64" LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8.exe
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf.exe
      - /builds/dps8m/dps8m/src/punutil/punutil.exe
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Source Kit:
  image: debian:sid
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - sh -x -c 'make dist V=1 COMPRESS="pigz -f" COMPRESSXT="gz" -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/sources.tar.gz
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu LTS, clang:
  image: ubuntu:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptAptInstallLibuv1
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu LTS, gcc:
  image: ubuntu:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptAptInstallLibuv1
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora Rawhide, clang:
  image: fedora:rawhide
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora Rawhide, gcc:
  image: fedora:rawhide
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora, clang:
  image: fedora:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Fedora, gcc:
  image: fedora:latest
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptDnfSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Oracle Linux 8, clang:
  image: oraclelinux:8
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptOUL8Setup
    - *scriptDnfSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Oracle Linux 8, gcc:
  image: oraclelinux:8
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptOUL8Setup
    - *scriptDnfSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu, clang:
  image: ubuntu:rolling
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptAptInstallLibuv1
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion -Weverything"; make CC=clang LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Linux/x86_64, Ubuntu, gcc:
  image: ubuntu:rolling
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptAptInstallLibuv1
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC=gcc LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
    - sh -x -c 'printf %s\\n "show version" | ./src/dps8/dps8 ; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf
      - /builds/dps8m/dps8m/src/punutil/punutil
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Windows/x86_64, Ubuntu, LLVM-MinGW, libuv/git:
  image: mstorsjo/llvm-mingw:dev
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvLLVMMGW64-x86_64
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC="x86_64-w64-mingw32-clang -I/usr/local/include -L/usr/local/lib -pthread" CROSS="MINGW64" LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8.exe
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf.exe
      - /builds/dps8m/dps8m/src/punutil/punutil.exe
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################

Windows/ARM64, Ubuntu, LLVM-MinGW, libuv/git:
  image: mstorsjo/llvm-mingw:dev
  stage: build
  tags:
    - Docker-amd64
  script:
    - *scriptAptSetup
    - *scriptCommon
    - *scriptDPS8Mods
    - *scriptExtraInfo
    - *scriptBuildlibuvLLVMMGW64-aarch64
    - sh -x -c 'export CFLAGS="${CFLAGS:-} -Wall -Wextra -fdata-sections -ffunction-sections -Wshadow -Wdouble-promotion -Wformat=2 -Wformat-truncation -Wundef -Wconversion"; make CC="aarch64-w64-mingw32-clang -I/usr/local/include -L/usr/local/lib -pthread" CROSS="MINGW64" LIBUV="/usr/local/lib/libuv.a -lpthread" LDFLAGS="-Wl,--gc-sections -Wl,--print-gc-sections" W=1 V=1 -j $(grep -c "^model name" /proc/cpuinfo 2> /dev/null || echo "4") --output-sync --print-directory -k; exit "${?}"'
  dependencies: []
  artifacts:
    paths:
      - /builds/dps8m/dps8m/src/dps8/dps8.exe
      - /builds/dps8m/dps8m/src/prt2pdf/prt2pdf.exe
      - /builds/dps8m/dps8m/src/punutil/punutil.exe
      - /builds/dps8m/dps8m/src/dps8/useddef.txt
  retry: 2
  timeout: 40 minutes
  interruptible: true

############################################################################
